package com.bank.paymentinitiation.adapter.out.persistence.mapper;

import com.bank.paymentinitiation.domain.model.ExternalReference;
import com.bank.paymentinitiation.domain.model.PayeeReference;
import com.bank.paymentinitiation.domain.model.PayerReference;
import com.bank.paymentinitiation.domain.model.PaymentAmount;
import com.bank.paymentinitiation.domain.model.PaymentOrder;
import com.bank.paymentinitiation.domain.model.PaymentStatus;
import com.bank.paymentinitiation.adapter.out.persistence.entity.PaymentOrderEntity;
import com.bank.paymentinitiation.adapter.out.persistence.entity.PaymentOrderStatusEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.Named;
import org.mapstruct.ReportingPolicy;

import java.time.LocalDateTime;

/**
 * MapStruct mapper for converting between domain models and persistence entities.
 * 
 * This mapper handles the transformation between:
 * - Domain models (PaymentOrder in domain.model package)
 * - JPA entities (PaymentOrderEntity in adapter.out.persistence.entity package)
 * 
 * Responsibilities:
 * - Convert PaymentOrder (domain) → PaymentOrderEntity (for saving)
 * - Convert PaymentOrderEntity → PaymentOrder (domain) (for loading)
 * 
 * This mapper will be implemented by MapStruct at compile time.
 * 
 * This is part of the persistence adapter, ensuring the domain layer
 * remains independent of JPA and database concerns.
 * 
 * Note: Flattens value objects from domain to simple fields in entity.
 */
@Mapper(
    componentModel = "spring",
    unmappedTargetPolicy = ReportingPolicy.ERROR
)
public interface PaymentOrderPersistenceMapper {
    
    /**
     * Converts a domain PaymentOrder to a JPA entity.
     * 
     * @param paymentOrder the domain PaymentOrder
     * @return the JPA entity
     */
    @Mapping(target = "id", ignore = true) // ID is generated by JPA
    @Mapping(target = "paymentOrderReference", source = "paymentOrderReference")
    @Mapping(target = "externalReference", source = "externalReference.value")
    @Mapping(target = "payerReference", source = "payerReference.value")
    @Mapping(target = "payeeReference", source = "payeeReference.value")
    @Mapping(target = "amount", source = "instructedAmount.value")
    @Mapping(target = "currency", source = "instructedAmount.currency")
    @Mapping(target = "remittanceInformation", source = "remittanceInformation")
    @Mapping(target = "requestedExecutionDate", source = "requestedExecutionDate")
    @Mapping(target = "status", source = "status", qualifiedByName = "domainStatusToEntity")
    @Mapping(target = "createdAt", source = "createdAt")
    @Mapping(target = "updatedAt", source = "updatedAt")
    PaymentOrderEntity toEntity(PaymentOrder paymentOrder);
    
    /**
     * Converts a JPA entity to a domain PaymentOrder.
     * 
     * @param entity the JPA entity
     * @return the domain PaymentOrder
     */
    @Mapping(target = "paymentOrderReference", source = "paymentOrderReference")
    @Mapping(target = "externalReference", source = "externalReference", qualifiedByName = "stringToExternalReference")
    @Mapping(target = "payerReference", source = "payerReference", qualifiedByName = "stringToPayerReference")
    @Mapping(target = "payeeReference", source = "payeeReference", qualifiedByName = "stringToPayeeReference")
    @Mapping(target = "instructedAmount", source = ".", qualifiedByName = "entityToPaymentAmount")
    @Mapping(target = "remittanceInformation", source = "remittanceInformation")
    @Mapping(target = "requestedExecutionDate", source = "requestedExecutionDate")
    @Mapping(target = "status", source = "status", qualifiedByName = "entityStatusToDomain")
    @Mapping(target = "createdAt", source = "createdAt")
    @Mapping(target = "updatedAt", source = "updatedAt")
    PaymentOrder toDomain(PaymentOrderEntity entity);
    
    // Named methods for custom conversions
    
    @Named("stringToExternalReference")
    default ExternalReference stringToExternalReference(String value) {
        return value != null ? ExternalReference.of(value) : null;
    }
    
    @Named("stringToPayerReference")
    default PayerReference stringToPayerReference(String value) {
        return value != null ? PayerReference.of(value) : null;
    }
    
    @Named("stringToPayeeReference")
    default PayeeReference stringToPayeeReference(String value) {
        return value != null ? PayeeReference.of(value) : null;
    }
    
    @Named("entityToPaymentAmount")
    default PaymentAmount entityToPaymentAmount(PaymentOrderEntity entity) {
        if (entity == null || entity.getAmount() == null || entity.getCurrency() == null) {
            return null;
        }
        return PaymentAmount.of(entity.getAmount(), entity.getCurrency());
    }
    
    @Named("domainStatusToEntity")
    default PaymentOrderStatusEntity domainStatusToEntity(PaymentStatus domainStatus) {
        if (domainStatus == null) {
            return null;
        }
        return PaymentOrderStatusEntity.valueOf(domainStatus.name());
    }
    
    @Named("entityStatusToDomain")
    default PaymentStatus entityStatusToDomain(PaymentOrderStatusEntity entityStatus) {
        if (entityStatus == null) {
            return null;
        }
        return PaymentStatus.valueOf(entityStatus.name());
    }
}
